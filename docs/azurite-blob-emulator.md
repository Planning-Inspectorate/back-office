### Setting up Azure Blob Store emulator locally

To run a local emulator, there are a number of required steps. In order to successfully write to the emulator, it is necessary to configure it over https, using a self-signed certificate, and with a Shared Access Signature (SAS).

1. The first step is to create a [local self-signed certificate](./self-signed-ssl.md)

2. Once the certificate is created, it needs to be accessible by docker, in order to start the Azurite emulator with https.
   The following command will create a docker container running the emulator, mapping a local folder containing the certificate (in the example below, the command is run from the folder containing the certificate `localhost+3.pem`, which is mapped and accessible from the docker container locally in the `/workspace` folder):

`docker run -p 10000:10000 -p 10001:10001 -p 10002:10002 -v ./:/workspace --name pins_azurite -d mcr.microsoft.com/azure-storage/azurite azurite --silent --blobHost 0.0.0.0 --cert /workspace/localhost+3.pem --key /workspace/localhost+3-key.pem --oauth basic --skipApiVersionCheck`

3. Once the emulator is running, it can be accessed by a client such as `Microsoft Azure Storage Explorer`. The self-signed certificate will not be trusted by default, so it can be added through the `Microsoft Azure Storage Explorer` edit menu; this can be troublesome on some OSs, but the client can be started with the `--ignore-certificate-errors` flag to avoid issues. On MacOS the command is as follows: `"/Applications/Microsoft Azure Storage Explorer.app/Contents/MacOS/Microsoft Azure Storage Explorer" --ignore-certificate-errors`

4. Once the client is up and running, please create a new container named `document-service-uploads` (this is where all the files will be stored). Additionally, you'll need to create a SAS over that container, which will be required to connect the application. The SAS url (in the format of `https://127.0.0.1:10000/devstoreaccount1/document-service-uploads?sv=2018-03-28&st=2023-06-02T12%3A00%3A42Z&se=2027-01-03T13%3A00%3A00Z&sr=c&sp=rwl&sig=yO2DcTNPhe40gZORzH3TGJ%2FUa%2FvPBfkSXHBJI3g%2FLQI%3D&api-version=2021-10-04`) is generated by right-clicking the `document-service-uploads` container and using the "Get Shared Access Signature feature". We suggest to set a long lease on the signature (it is only for local development with the emulator), and to ensure basic CRUD is allowed.

5. Ensure CORS is properly configured on the blob container. In `Microsoft Azure Storage Explorer`, in the sidebar, expand `Storage Accounts > pins_azurite (Key)`, right click on `Blob Containers` and select `Configure CORS settings`. Add a new rule named `*` (or edit if already present), with the following settings:

```
Allowed Origins: *
Allowed Methods: GET;PUT
Allowed Headers: *
Exposed Headers: *
Max Age (in seconds): 5
```

Be sure to save the new rule.

6. The final step is to configure the application to use the emulator. That is achieved by adding the following to `./appeals/web/.env`:

```
AZURE_BLOB_DEFAULT_CONTAINER=document-service-uploads
AZURE_BLOB_EMULATOR_SAS_HOST=<obtained in step 4>
AZURE_BLOB_STORE_HOST=https://127.0.0.1:10000/devstoreaccount1/
AZURE_BLOB_USE_EMULATOR=true
NODE_TLS_REJECT_UNAUTHORIZED=0
```
