trigger:
    branches:
        include:
            - main # run on main before build
            # trigger for merge queue branches
            - gh-readonly-queue/*

pr:
    branches:
        include:
            - '*'
    paths:
        exclude:
            - infrastructure

resources:
    repositories:
        - repository: templates
          type: github
          endpoint: Planning-Inspectorate
          name: Planning-Inspectorate/common-pipeline-templates
          ref: refs/tags/release/3.17.0

extends:
    template: stages/wrapper_ci.yml@templates
    parameters:
        pool:
            name: pins-odt-agent-pool
        gitFetchDepth: 0
        globalVariables:
            - template: azure-pipelines-variables.yml@self
        validationJobs:
            - name: Run Linting & API Tests
              steps:
                  - script: git fetch origin main:main
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm ci
                  - template: ../steps/node_script.yml
                    parameters:
                        # only run commitlint on branches, not main
                        condition: ne(variables['Build.SourceBranchName'], 'main')
                        nodeVersion: 20
                        script: npm run commitlint
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm run tscheck
                        environmentVariables:
                            TURBO_TEAM: $(TURBO_TEAM)
                            TURBO_API: $(TURBO_API)
                            TURBO_TOKEN: $(TURBO_TOKEN)
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm run lint:js
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm run format-check
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        # Run tests for a subset of apps on Agent A
                        script: npx turbo run test --filter=./apps/api
                        environmentVariables:
                            TURBO_TEAM: $(TURBO_TEAM)
                            TURBO_API: $(TURBO_API)
                            TURBO_TOKEN: $(TURBO_TOKEN)
            - name: Run Web and Function Tests
              steps:
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm ci
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        # Run tests for the remaining apps on Agent B
                        script: npx turbo run test --filter=./apps/web --filter=./apps/api-testing --filter=./apps/functions/*
                        environmentVariables:
                            TURBO_TEAM: $(TURBO_TEAM)
                            TURBO_API: $(TURBO_API)
                            TURBO_TOKEN: $(TURBO_TOKEN)
                  - template: ../steps/node_script.yml
                    parameters:
                        nodeVersion: 20
                        script: npm run build:release
                        environmentVariables:
                            TURBO_TEAM: $(TURBO_TEAM)
                            TURBO_API: $(TURBO_API)
                            TURBO_TOKEN: $(TURBO_TOKEN)
