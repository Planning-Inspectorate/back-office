{% extends "layouts/form.njk" %}

{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "components/address.njk" import address %}
{% from "components/button-group.njk" import buttonGroup %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% set yourDetails = appealData.aboutYouSection.yourDetails %}
{% set originalApplicationFile = appealData.requiredDocumentsSection.originalApplication.uploadedFile %}
{% set decisionLetterFile = appealData.requiredDocumentsSection.decisionLetter.uploadedFile %}
{% set appealStatementFile = appealData.yourAppealSection.appealStatement.uploadedFile %}
{% set completedError = errors['check-and-confirm-completed'].msg %}

{% macro renderValidReason() %}
  {{ validAppealDetails }}
{% endmacro %}

{% macro renderInvalidReason() %}
  {% for item in invalidAppealDetails.reasons %}
    <li>{{ getText(item) + (' - ' + invalidAppealDetails.otherReason if item === '5') }}</li>
  {% endfor %}
{% endmacro %}

{% macro renderIncompleteReason() %}
  {% for item in missingOrWrongDetails.reasons %}
    {% if item === 'missingOrWrongDocuments' %}
      <li>
        {{ getText(item) }}
        <ul class="govuk-list govuk-list--bullet">
          {% for documentReason in missingOrWrongDetails.documentReasons %}
            <li>{{ getText(documentReason) }}</li>
          {% endfor %}
        </ul>
      </li>
    {% else %}
      <li>{{ getText(item) + (' - ' + invalidAppealDetails.otherReason if item === 'other') }}</li>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro renderCheckAndConfirmReason() %}
    {% if reviewOutcome === '1' %}
      {{ renderValidReason() }}
    {% else %}
      <ul class="govuk-list">
        {% if reviewOutcome === '2' %}
          {{ renderInvalidReason() }}
        {% elif reviewOutcome === '3' %}
          {{ renderIncompleteReason() }}
        {% endif %}
      </ul>
    {% endif %}
{% endmacro %}

{% block formContent %}

  {{ govukSummaryList({
    rows: [
      {
        key: { text: "Outcome of review" },
        value: { text: checkAndConfirmConfig.text }
      },
      {
        key: { text: "Appellant name" },
        value: { text: appealData.appellantName if appealData.creatorOriginalApplicant else appealData.creatorName }
      },
      { key: { text: "Appeal reference" },
        value: { text: appealData.caseReference }
      },
      {
        key: { text: "Appeal site" },
        value: { html: address({
          addressLine1: appealData.siteAddressLineOne,
          addressLine2: appealData.siteAddressLineTwo,
          town: appealData.siteAddressTown,
          county: appealData.siteAddressCounty,
          postcode: appealData.siteAddressPostCode
        }) }
      },
      {
        key: { text: checkAndConfirmConfig.reasonText },
        value: { html: renderCheckAndConfirmReason() }
      }
    ]
  }) }}

  {% if reviewOutcome === '1' %}
    {{ govukWarningText({
      iconFallbackText: "Warning",
      text: "Confirming this appeal as valid starts the appeal and sends the LPA questionnaire email."
    }) }}
  {% elif reviewOutcome === '2' %}
    {{ govukWarningText({
      iconFallbackText: "Warning",
      text: "Confirming this appeal as invalid turns away the appeal and emails the appellant and LPA."
    }) }}
  {% elif reviewOutcome === '3' %}
    {{ govukCheckboxes({
      idPrefix: "check-and-confirm-completed",
      name: "check-and-confirm-completed",
      classes: "govuk-checkboxes--small",
      errorMessage: completedError and {
        text: completedError
      },
      items: [
        {
          value: "true",
          text: "I have completed all follow-up tasks and emails",
          checked: completed === 'true'
        }
      ]
    }) }}
  {% endif %}

  {{ buttonGroup(changeOutcomeLink, undefined, checkAndConfirmConfig.continueButtonText) }}

{% endblock %}
