{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% macro appealTable(params) %}
  {% set head = [] %}
  {% set rows = [] %}

  {% for column in params.columns %}
    {% if column.name === 'Status' %}
      {% set head = head | concat({ html: '<span class="pins-table__cell--xs govuk-visually-hidden">Status</span>' }) %}
    {% else %}
      {% set head = head | concat({ text: column.name }) %}
    {% endif %}
  {% endfor %}

  {% for appeal in params.appeals %}
    {% set cells = [] %}
    
    {% for column in params.columns %}
      {% set cell = {} %}

      {% switch column.name %}
        {% case 'Appeal age' %}
          {% set suffix = 'day' if appeal.appealAge === 1 else 'days' %}
          {% set cell = { text: appeal.appealAge + ' ' + suffix,  classes: 'pins-table__cell--s' } %}
        {% case 'Appeal reference' %}
          {% if column.href %}
            {% set cell = { html: createAppealLink(appeal), classes: 'pins-table__cell--l' } %}
          {% else %}
            {% set cell = { text: appeal.reference, classes: 'pins-table__cell--l' } %}
          {% endif %}
        {% case 'Appeal site' %}
          {% set cell = { text: appeal.appealSite | collapse(', ') } %}
        {% case 'Appeal type' %}
          {% set cell = { text: appeal.appealType, classes: 'pins-table__cell--s' } %}
        {% case 'Assigned to' %}
          {% set cell = { text: appeal.assignedTo } %}
        {% case 'Postcode' %}
          {% set cell = { text: appeal.appealSite.postCode or appeal.address.postcode } %}
        {% case 'Provisional site visit type' %}
          {% set cell = { text: appeal.provisionalVisitType | capitalize, classes: 'pins-table__cell--m' } %}
        {% case 'Recommended site visit' %}
          {% set cell = { text: appeal.provisionalVisitType | capitalize } %}
        {% case 'Specialism' %}
          {% set cell = { text: 'Specialism' } %}
        {% case 'Site visit date' %}
          {% set cell = { text: appeal.siteVisitDate, classes: 'pins-table__cell--s' } %}
        {% case 'Site visit time' %}
          {% set cell = { text: appeal.siteVisitSlot } %}
        {% case 'Site visit type' %}
          {% set cell = { text: appeal.siteVisitType | capitalize, classes: 'pins-table__cell--s' } %}
        {% case 'Select' %}
          {% set cell = {
            attributes: { style: 'padding-top: 2px' },
            html: createCheckboxCell({
              label: 'Select AppealReference',
              checked: params.selected | includes(appeal.appealId),
              value: appeal.appealId
            })
          } %}
        {% case 'Status' %}
          {% set status = params.statuses | find({ appealId: appeal.appealId }) %}
          {% if status and status.text === 'New' %}
            {% set cell = { html: govukTag({ text: 'New', classes: 'govuk-tag--green' }) } %}
          {% endif %}          
      {% endswitch %}

      {% set cells = cells | concat(cell) %}      
    {% endfor %}

    {% set rows = rows | concat([cells]) %}
  {% endfor %}

  {{
    govukTable({
      caption: params.caption,
      captionClasses: "govuk-table__caption--l",
      classes: params.classes | default('govuk-!-margin-bottom-9'),
      head: head,
      rows: rows
    })
  }}
{% endmacro %}

{% macro createAppealLink(appeal) %}
  <a class="govuk-link" href="/inspector/appeals/{{ appeal.appealId }}">{{ appeal.reference }}</a>
{% endmacro %}

{% macro createCheckboxCell(params) %}
  <div class="govuk-checkboxes govuk-checkboxes--small">
    <div class="govuk-checkboxes__item">
      <input id="{{ params.value }}" class="govuk-checkboxes__input" name="appealIds[]" type="checkbox" value="{{ params.value }}" {{-" checked" if params.checked }}>
      <label class="govuk-label govuk-checkboxes__label" for="{{ params.value }}">
        <span class="govuk-visually-hidden">{{ params.label }}</span>
      </label>
    </div>
  </div>
{% endmacro %}
