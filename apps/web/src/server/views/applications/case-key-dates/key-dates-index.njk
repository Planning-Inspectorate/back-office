{% extends "../case/layouts/applications-case-layout.njk" %}
{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "./key-dates.component.njk" import createSummaryList %}

{% set pageTitle = 'Key dates' %}

{% block sectionContent %}
	<h3 class="govuk-heading-m">{{ pageTitle }}</h3>
	<p class="govuk-body">Provide details on dates and deadlines in this project.</p>
	<hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

	{% set headingMap = {
  preApplication: 'Pre-application dates',
  acceptance: 'Acceptance dates',
  preExamination: 'Pre-examination',
  examination: 'Examination dates',
  recommendation: 'Recommendation dates',
  decision: 'Decision dates',
  postDecision: 'Judicial review dates',
  withdrawal: 'Withdrawal dates'
} %}

	{% set items = [] %}

	{% for key, section in sections %}
		{% set heading = key | keyDatesProperty %}

		{% if key === 'preApplication' %}
			{# Handle special case for preApplication with subsections #}
			{% set subsectionHtml %}
				{% for subsectionKey, subsectionData in section %}
					{% set subsectionHeading = subsectionKey | keyDatesProperty %}
					{# Add "dates" suffix for subsection titles in accordion view #}
					{% if subsectionKey === 'preApplicationSection' or subsectionKey === 'screeningAndScoping' %}
						{% set subsectionHeading = subsectionHeading + ' dates' %}
					{% endif %}

					{{ createSummaryList(subsectionData, subsectionKey, subsectionHeading, caseId, headingMap) }}
				{% endfor %}
			{% endset %}

			{% set items = items | concat([{
				heading: { html: heading },
				content: { html: subsectionHtml }
			}]) %}
		{% else %}
			{# Handle regular sections #}
			{% set summaryListHtml %}
				{{ createSummaryList(section, key, heading, caseId, headingMap) }}
			{% endset %}

			{% set items = items | concat([{
				heading: { html: heading },
				content: { html: summaryListHtml }
			}]) %}
		{% endif %}
	{% endfor %}

	{{ govukAccordion({
		id: "accordion-key-dates",
		items: items
	}) }}
{% endblock %}
