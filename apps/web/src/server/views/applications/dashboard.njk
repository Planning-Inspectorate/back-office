{% extends "app/layouts/app.layout.njk" %}

{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% set pageCaption = domainType | displayValue  %}
{% set pageTitle = 'Applications' %}

{% block pageContent %}
  <h2 class="govuk-heading-l">Open applications</h2>

  {% set items = [] %}

  {% for name, groupedApplications in applications | groupBy('sector.name') %}
    {% set items = items.concat({
        heading: {
          text: groupedApplications[0].sector.displayNameEn
        },
        content: {
          html: createSectorContent(groupedApplications)
        }
      })
    %}
  {% endfor %}

  {{ govukAccordion({ items: items }) }}
{% endblock %}

{% macro createSectorContent(applicationsForSector) %}
  {% for name, groupedApplications in applicationsForSector | groupBy('subSector.name') %}
    {% set subSector = groupedApplications[0].subSector %}
    {% set rows = [] %}
    {% for application in groupedApplications %}
      {% set rows = rows | concat ([[
        { html: applicationLink(application) },
        { text: application.modifiedDate | datestamp } 
      ]]) %}
    {% endfor %}
    {{
      govukDetails({
        summaryText: subSector.abbreviation + ' ' + subSector.displayNameEn,
        html: govukTable({
          classes: 'pins-table--fixed pins-table--bordered',
          head: [
            { text: "Application reference" },
            { text: "Modified", classes: 'pins-table__cell--s' }
          ],
          rows: rows
        })
      })
    }}
  {% endfor %}
{% endmacro %}

{% macro applicationLink(application) %}
  <a class="govuk-link" href="/applications-service/{{ domainType }}/applications/{{ application.id }}">
    {{ application.reference }}
  </a>
{% endmacro %}
