{% extends "app/layouts/app.layout.njk" %}

{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageCaption = domainType | displayValue %}
{% set pageTitle = 'Applications' %}

{% block pageContent %}


	<div class="govuk-grid-row">
		<div class="govuk-grid-column-two-thirds">
			<div class="pins-dashboard-box">
				{% include 'app/includes/csrf.njk' %}
				<h3 class="govuk-heading-l">Search applications</h3>
				<form method="post" novalidate  class="pins-dashboard-form">

					{{ govukInput({
						label: {
							text: "Enter reference, or something else indicative",
							isPageHeading: false
						},
						errorMessage:searchApplicationsError,
						inputmode: "search",
						id: "SearchApplications",
						name: "SearchApplications"
					}) }}

					{{ govukButton({
						text: "Continue"
					}) }}
				</form>
			</div>
		</div>
		<div class="govuk-grid-column-one-third">
			<div class="pins-dashboard-box">
				<h3 class="govuk-heading-m">Create new project folder</h3>
			</div>
		</div>
	</div>






	<h2 class="govuk-heading-l">Open applications</h2>

	{% set items = [] %}

	{% for name, groupedApplications in applications | groupBy('sector.name') %}
		{% set items = items.concat({
			heading: {
				text: groupedApplications[0].sector.displayNameEn
			},
			content: {
				html: createSectorContent(groupedApplications)
			}
		}) %}
	{% endfor %}

	{{ govukAccordion({ items: items }) }}
{% endblock %}

{% macro createSectorContent(applicationsForSector) %}
	{% for name, groupedApplications in applicationsForSector | groupBy('subSector.name') %}
		{% set subSector = groupedApplications[0].subSector %}
		{% set rows = [] %}
		{% for application in groupedApplications %}
			{% set rows = rows | concat ([[
				{ html: applicationLink(application) },
				{ text: application.modifiedDate | datestamp }
			]]) %}
		{% endfor %}
		{{ govukDetails({
			summaryText: subSector.abbreviation + ' ' + subSector.displayNameEn,
			html: govukTable({
				classes: 'pins-table--fixed pins-table--bordered',
				head: [
					{ text: "Application reference" },
					{ text: "Modified", classes: 'pins-table__cell--s' }
				],
				rows: rows
			})
		}) }}
	{% endfor %}
{% endmacro %}

{% macro applicationLink(application) %}
	<a class="govuk-link" href="/applications-service/{{ domainType }}/applications/{{ application.id }}">
		{{ application.reference }}
	</a>
{% endmacro %}
