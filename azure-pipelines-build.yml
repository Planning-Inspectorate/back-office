parameters:
  - name: buildAppsBoApi
    displayName: Build Applications BO API
    type: boolean
    default: true
  - name: buildAppsBoWeb
    displayName: Build Applications BO Web
    type: boolean
    default: true
  - name: buildAppealsBoApi
    displayName: Build Appeals BO API
    type: boolean
    default: true
  - name: buildAppealsBoWeb
    displayName: Build Appeals BO Web
    type: boolean
    default: true
  - name: buildFunctions
    displayName: Build All Functions
    type: boolean
    default: true

pr: none

trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/tags/release/3.4.0

extends:
  template: stages/wrapper_ci.yml@templates
  parameters:
    globalVariables:
      - template: azure-pipelines-variables.yml@self
    validationJobs:
      - name: Run Linting & Tests
        steps:
          - template: ../steps/node_script.yml
            parameters:
              nodeVersion: 18
              script: npm ci
          - template: ../steps/node_script.yml
            parameters:
              nodeVersion: 18
              script: npm run tscheck
              environmentVariables:
                TURBO_TEAM: $(TURBO_TEAM)
                TURBO_API: $(TURBO_API)
          - template: ../steps/node_script.yml
            parameters:
              nodeVersion: 18
              script: npm run lint:js
          - template: ../steps/node_script.yml
            parameters:
              nodeVersion: 18
              script: npm run test
              environmentVariables:
                TURBO_TEAM: $(TURBO_TEAM)
                TURBO_API: $(TURBO_API)
                TURBO_TOKEN: $(TURBO_TOKEN)
      - name: Build Applications BO API
        condition: >-
          and(
            succeeded(),
            or(
              and(
                eq(variables['Build.Reason'], 'Manual'),
                eq(${{ parameters.buildAppsBoApi }}, 'true')
              ),
              ne(variables['Build.Reason'], 'Manual')
            )
          )
        dependsOn:
          - Run Linting & Tests
        steps:
          - template: ../steps/azure_web_app_docker_build_push.yml@templates
            parameters:
              azurecrName: $(azurecrName)
              dockerfilePath: $(Build.SourcesDirectory)/apps/api/Dockerfile
              repository: back-office/back-office-api
      - name: Build Applications BO Web
        condition: >-
          and(
            succeeded(),
            or(
              and(
                eq(variables['Build.Reason'], 'Manual'),
                eq(${{ parameters.buildAppsBoWeb }}, 'true')
              ),
              ne(variables['Build.Reason'], 'Manual')
            )
          )
        dependsOn:
          - Run Linting & Tests
        steps:
          - template: ../steps/azure_web_app_docker_build_push.yml@templates
            parameters:
              azurecrName: $(azurecrName)
              dockerfilePath: $(Build.SourcesDirectory)/apps/web/Dockerfile
              repository: back-office/back-office-web

      - name: Build Appeals BO API
        condition: >-
          and(
            succeeded(),
            or(
              and(
                eq(variables['Build.Reason'], 'Manual'),
                eq(${{ parameters.buildAppealsBoApi }}, 'true')
              ),
              ne(variables['Build.Reason'], 'Manual')
            )
          )
        dependsOn:
          - Run Linting & Tests
        steps:
          - template: ../steps/azure_web_app_docker_build_push.yml@templates
            parameters:
              azurecrName: $(azurecrName)
              dockerfilePath: $(Build.SourcesDirectory)/appeals/api/Dockerfile
              repository: back-office/back-office-appeals-api
      - name: Build Appeals  BO Web
        condition: >-
          and(
            succeeded(),
            or(
              and(
                eq(variables['Build.Reason'], 'Manual'),
                eq(${{ parameters.buildAppealsBoWeb }}, 'true')
              ),
              ne(variables['Build.Reason'], 'Manual')
            )
          )
        dependsOn:
          - Run Linting & Tests
        steps:
          - template: ../steps/azure_web_app_docker_build_push.yml@templates
            parameters:
              azurecrName: $(azurecrName)
              dockerfilePath: $(Build.SourcesDirectory)/appeals/web/Dockerfile
              repository: back-office/appeals-web

      - name: Build All Functions
        condition: >-
          and(
            succeeded(),
            or(
              and(
                eq(variables['Build.Reason'], 'Manual'),
                eq(${{ parameters.buildFunctions }}, 'true')
              ),
              ne(variables['Build.Reason'], 'Manual')
            )
          )
        dependsOn:
          - Run Linting & Tests
        steps:
          # install only function deps
          - template: ../steps/node_script.yml
            parameters:
              nodeVersion: 18
              script: npm ci --only=prod --workspace=@pins/functions-applications-migration --workspace=@pins/functions-applications-background-jobs --workspace=@pins/functions-applications-command-handlers --workspace=@pins/functions-bo-appeals-casedata-import --workspace=@pins/functions-bo-appeals-user-import --workspace=@pins/functions-bo-appeals-document-processing
          # merge node modules
          - template: azure-pipelines-package-function-merge.yml@self
            parameters:
              appsFolderNames:
                - 'applications-migration'
                - 'applications-background-jobs'
                - 'applications-command-handlers'
              appealsFolderNames:
                - 'casedata-import'
                - 'user-import'
                - 'document-processing'

          # package Applications BO migration function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'apps'
              folderName: 'applications-migration'
          
          # package Applications BO background jobs function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'apps'
              folderName: 'applications-background-jobs'

          # package Applications BO command handlers function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'apps'
              folderName: 'applications-command-handlers'

          # package Appeals BO case data function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'appeals'
              folderName: 'casedata-import'
          
          # package Appeals BO user function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'appeals'
              folderName: 'user-import'

          # package Appeals BO document function
          - template: azure-pipelines-package-function.yml@self
            parameters:
              root: 'appeals'
              folderName: 'document-processing'