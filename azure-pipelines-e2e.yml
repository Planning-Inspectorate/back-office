parameters:
  - name: Environment
    default: dev
    values:
      - dev
      - test
  - name: APP
    default: applications
    values:
      - applications
      - appeals

variables:
  - name: APP
    value: ${{parameters.APP}}
  - group: e2e-${{parameters.Environment}}

pr:
  branches:
    include:
      - main
  paths:
    include:
      - apps

jobs:
  - job: Run_Cypress_Tests
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - task: Docker@2
        displayName: 'Build Docker image'
        inputs:
          command: build
          Dockerfile: 'Dockerfile'
          tags: 'my-cypress-tests'
          workingDirectory: 'apps/e2e'

      - task: Docker@2
        displayName: 'Run Cypress tests'
        inputs:
          command: run
          containerCommand: '-v "$(pwd)/failed-tests:/app/cypress/screenshots" my-cypress-tests'
          envVars: >
            BASE_URL=$(BASE_URL)
            CASE_TEAM_EMAIL=$(CASE_TEAM_EMAIL)
            CASE_ADMIN_EMAIL=$(CASE_ADMIN_EMAIL)
            INSPECTOR_EMAIL=$(INSPECTOR_EMAIL)
            USER_PASSWORD=$(USER_PASSWORD)
          workingDirectory: 'apps/e2e'
          displayName: "Run Cypress Tests in Docker"

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: 'apps/e2e/cypress/failed-tests'
          artifactName: 'FailedTests'
        displayName: "Publish FailedTests Artifacts"
        condition: failed()
